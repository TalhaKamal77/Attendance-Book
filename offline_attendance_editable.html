<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Offline Attendance System - Editable</title>
  <!-- SheetJS for .xlsx export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    h1, h2 { text-align: center; }
    input, select, button { padding: 5px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 8px; }
    .btns button { margin: 0 2px; }
  </style>
</head>
<body>

<h1>📘 Offline Attendance System (Editable)</h1>

<h2>1️⃣ Subject & Teacher</h2>
<input type="text" id="newSubject" placeholder="Subject name">
<input type="text" id="newTeacher" placeholder="Teacher name">
<button onclick="addSubject()">Add Subject</button>

<select id="subjectSelect" onchange="loadStudents()">
  <option disabled selected>Select subject</option>
</select>
<button onclick="deleteSubject()">🗑 Delete Subject</button>

<h2>2️⃣ Student Management</h2>
<label>Copy students from: </label>
<select id="copyFromSelect"></select>
<button onclick="copyStudentsFrom()">📋 Copy Students</button>
<br>
<input type="text" id="studentName" placeholder="Student name">
<button onclick="addStudent()">Add Student</button>

<table id="studentTable">
  <thead><tr><th>Name</th><th>Actions</th></tr></thead>
  <tbody></tbody>
</table>

<h2>3️⃣ Mark Attendance</h2>
<table id="attendanceTable">
  <thead><tr><th>Name</th><th>Present</th><th>Leave</th><th>Absent</th></tr></thead>
  <tbody></tbody>
</table>

<button onclick="saveAttendance()">✅ Save Attendance</button>
<button onclick="exportToExcel()">📁 Export .xlsx (no colors)</button>
<button onclick="exportToExcelWithColorsHtml()">📁 Export .xls (colored)</button>

<h2>4️⃣ Edit Past Attendance</h2>
<input type="date" id="editDate">
<button onclick="loadPastAttendance()">Load</button>
<table id="pastAttendanceTable">
  <thead><tr><th>Name</th><th>Present</th><th>Leave</th><th>Absent</th></tr></thead>
  <tbody></tbody>
</table>
<button onclick="savePastAttendance()">💾 Save Changes</button>

<script>
  let subjects = JSON.parse(localStorage.getItem('subjects') || '{}');
  let selectedSubject = null;

  function updateSubjectSelect() {
    const select = document.getElementById('subjectSelect');
    select.innerHTML = '<option disabled selected>Select subject</option>';
    for (let sub in subjects) {
      let opt = document.createElement('option');
      opt.value = sub;
      opt.textContent = sub + " (" + subjects[sub].teacher + ")";
      select.appendChild(opt);
    }
    updateCopyFromSelect();
  }

  function updateCopyFromSelect() {
    const select = document.getElementById('copyFromSelect');
    select.innerHTML = '<option disabled selected>Select subject</option>';
    for (let sub in subjects) {
      if (sub !== selectedSubject) {
        let opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub + " (" + subjects[sub].teacher + ")";
        select.appendChild(opt);
      }
    }
  }

  function copyStudentsFrom() {
    if (!selectedSubject) return alert("Select a target subject first!");
    const fromSubject = document.getElementById('copyFromSelect').value;
    if (!fromSubject || !subjects[fromSubject]) return alert("Select a valid source subject!");

    let copiedCount = 0;
    subjects[fromSubject].students.forEach(name => {
      if (!subjects[selectedSubject].students.includes(name)) {
        subjects[selectedSubject].students.push(name);
        copiedCount++;
      }
    });
    saveData();
    loadStudents();
    alert(copiedCount + " students copied from " + fromSubject + " to " + selectedSubject);
  }

  function addSubject() {
    const name = document.getElementById('newSubject').value.trim();
    const teacher = document.getElementById('newTeacher').value.trim();
    if (name && teacher && !subjects[name]) {
      subjects[name] = { teacher, students: [], attendance: {} };
      saveData();
      updateSubjectSelect();
      document.getElementById('newSubject').value = '';
      document.getElementById('newTeacher').value = '';
    }
  }

  function deleteSubject() {
    if (!selectedSubject) return alert("Select a subject first!");
    if (confirm("Delete subject '" + selectedSubject + "'?")) {
      delete subjects[selectedSubject];
      saveData();
      updateSubjectSelect();
      selectedSubject = null;
      document.querySelector('#studentTable tbody').innerHTML = '';
      document.querySelector('#attendanceTable tbody').innerHTML = '';
    }
  }

  function addStudent() {
    if (!selectedSubject) return alert("Select a subject first!");
    const name = document.getElementById('studentName').value.trim();
    if (name) {
      if (!subjects[selectedSubject].students.includes(name)) {
        subjects[selectedSubject].students.push(name);
        saveData();
        loadStudents();
      } else {
        alert("This student name already exists in this subject!");
      }
      document.getElementById('studentName').value = '';
    }
  }

  function editStudent(oldName) {
    const newName = prompt("Enter new student name:", oldName);
    if (newName && !subjects[selectedSubject].students.includes(newName)) {
      const idx = subjects[selectedSubject].students.indexOf(oldName);
      subjects[selectedSubject].students[idx] = newName;
      for (let date in subjects[selectedSubject].attendance) {
        subjects[selectedSubject].attendance[date][newName] = subjects[selectedSubject].attendance[date][oldName];
        delete subjects[selectedSubject].attendance[date][oldName];
      }
      saveData();
      loadStudents();
    }
  }

  function deleteStudent(name) {
    subjects[selectedSubject].students = subjects[selectedSubject].students.filter(n => n !== name);
    for (let date in subjects[selectedSubject].attendance) {
      delete subjects[selectedSubject].attendance[date][name];
    }
    saveData();
    loadStudents();
  }

  function loadStudents() {
    selectedSubject = document.getElementById('subjectSelect').value;
    updateCopyFromSelect();
    const students = subjects[selectedSubject]?.students || [];

    const stBody = document.querySelector('#studentTable tbody');
    stBody.innerHTML = '';
    students.forEach(name => {
      let row = stBody.insertRow();
      row.insertCell(0).textContent = name;
      let btns = document.createElement('div');
      btns.className = 'btns';
      let editBtn = document.createElement('button');
      editBtn.textContent = '✏ Edit';
      editBtn.onclick = () => editStudent(name);
      btns.appendChild(editBtn);
      let delBtn = document.createElement('button');
      delBtn.textContent = '❌ Delete';
      delBtn.onclick = () => deleteStudent(name);
      btns.appendChild(delBtn);
      row.insertCell(1).appendChild(btns);
    });

    const attBody = document.querySelector('#attendanceTable tbody');
    attBody.innerHTML = '';
    students.forEach(name => {
      let row = attBody.insertRow();
      row.insertCell(0).textContent = name;
      ["Present", "Leave", "Absent"].forEach(status => {
        let td = document.createElement('td');
        let btn = document.createElement('input');
        btn.type = 'radio';
        btn.name = 'att_' + name;
        btn.value = status;
        td.appendChild(btn);
        row.appendChild(td);
      });
    });
  }

  function saveAttendance() {
    if (!selectedSubject) return alert("Select a subject first!");
    let date = new Date().toISOString().split('T')[0];
    if (!subjects[selectedSubject].attendance[date]) {
      subjects[selectedSubject].attendance[date] = {};
    }
    subjects[selectedSubject].students.forEach(name => {
      let selected = document.querySelector('input[name="att_' + name + '"]:checked');
      subjects[selectedSubject].attendance[date][name] = selected ? selected.value : '';
    });
    saveData();
    alert("Attendance saved for " + date);
  }

  function loadPastAttendance() {
    if (!selectedSubject) return alert("Select a subject first!");
    const date = document.getElementById('editDate').value;
    if (!date) return alert("Select a date!");
    const students = subjects[selectedSubject].students;
    const pastBody = document.querySelector('#pastAttendanceTable tbody');
    pastBody.innerHTML = '';
    students.forEach(name => {
      let row = pastBody.insertRow();
      row.insertCell(0).textContent = name;
      ["Present", "Leave", "Absent"].forEach(status => {
        let td = document.createElement('td');
        let btn = document.createElement('input');
        btn.type = 'radio';
        btn.name = 'past_' + name;
        btn.value = status;
        if (subjects[selectedSubject].attendance[date]?.[name] === status) btn.checked = true;
        td.appendChild(btn);
        row.appendChild(td);
      });
    });
  }

  function savePastAttendance() {
    if (!selectedSubject) return alert("Select a subject first!");
    const date = document.getElementById('editDate').value;
    if (!date) return alert("Select a date!");
    if (!subjects[selectedSubject].attendance[date]) subjects[selectedSubject].attendance[date] = {};
    subjects[selectedSubject].students.forEach(name => {
      let selected = document.querySelector('input[name="past_' + name + '"]:checked');
      subjects[selectedSubject].attendance[date][name] = selected ? selected.value : '';
    });
    saveData();
    alert("Past attendance updated for " + date);
  }

  function exportToExcel() {
    if (!selectedSubject) return alert("Select a subject first!");
    const subject = subjects[selectedSubject];
    const dates = Object.keys(subject.attendance).sort();
    const sheetData = [];

    sheetData.push(["Subject: " + selectedSubject + " | Teacher: " + subject.teacher]);
    sheetData.push([]);
    const header = ["Name", ...dates];
    sheetData.push(header);

    subject.students.forEach(name => {
      const row = [name];
      dates.forEach(date => {
        let val = subject.attendance[date]?.[name] || "";
        if (val === "Present") val = "P";
        else if (val === "Leave") val = "L";
        else if (val === "Absent") val = "A";
        row.push(val);
      });
      sheetData.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    const colWidths = header.map((_, colIndex) => {
      let maxLen = 0;
      sheetData.forEach(row => {
        const cell = row[colIndex] ? row[colIndex].toString() : "";
        if (cell.length > maxLen) maxLen = cell.length;
      });
      return { wch: maxLen + 2 };
    });
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, selectedSubject + "_Attendance");
    XLSX.writeFile(wb, selectedSubject + "_Attendance.xlsx");
  }

  function exportToExcelWithColorsHtml() {
    if (!selectedSubject) return alert("Select a subject first!");
    const subject = subjects[selectedSubject];
    const dates = Object.keys(subject.attendance).sort();

    let html = '<html><head><meta charset="UTF-8"></head><body>';
    html += '<table border="1" cellpadding="4" cellspacing="0" style="border-collapse:collapse;">';

    html += '<tr><th colspan="' + (dates.length + 1) + '" style="text-align:left;">'
         + escapeHtml("Subject: " + selectedSubject + " | Teacher: " + subject.teacher)
         + '</th></tr>';

    html += '<tr><td colspan="' + (dates.length + 1) + '"></td></tr>';

    html += '<tr><th>Name</th>';
    dates.forEach(d => { html += '<th>' + escapeHtml(d) + '</th>'; });
    html += '</tr>';

    subject.students.forEach(name => {
      html += '<tr>';
      html += '<td>' + escapeHtml(name) + '</td>';
      dates.forEach(date => {
        const raw = subject.attendance[date]?.[name] || "";
        let code = "", bg = "", color = "";
        if (raw === "Present") { code = "P"; bg = "#C6EFCE"; color = "#006100"; }
        else if (raw === "Leave") { code = "L"; bg = "#FFEB9C"; color = "#9C6500"; }
        else if (raw === "Absent") { code = "A"; bg = "#FFC7CE"; color = "#9C0006"; }
        if (bg) {
          html += '<td style="background-color:' + bg + '; color:' + color + '; text-align:center;">' + escapeHtml(code) + '</td>';
        } else {
          html += '<td style="text-align:center;">' + escapeHtml(code) + '</td>';
        }
      });
      html += '</tr>';
    });

    html += '</table></body></html>';

    const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = selectedSubject + '_Attendance.xls';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return "";
    return text.toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function saveData() {
    localStorage.setItem('subjects', JSON.stringify(subjects));
  }

  updateSubjectSelect();
</script>

</body>
</html>
